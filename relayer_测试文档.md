# Relayer测试文档

## 目录树
```
├───cmd
├───config
├───contract
├───db
│   └───db
├───log
├───manager
├───toolbox
├───tools
└───proof
```

## 相关参数
```
侧链ID  "SideChainId": 17
路由号   RoutineNum: 10
侧链名   chainName: "testChain017"
合约地址"contractAddress" : "ddcccmanager"
bookkeeper表名"polyglobal"

Poly当前高度 current height is 4064194  同步周期高度4020000
```

后台运行命令： nohup go run main.go 1>Log/myout.log 2>Log/err.log &

### 配置参数调优

极限同步高度5500
同步时间约为1分15秒~1分30秒之间（其中，Poly同步侧链到成功出块占1分钟到一分15秒之间）

### 跨链初始化

#### 注册侧链
注册侧链逻辑
 - 注册侧链         注册侧链需任意一个Poly同步节点账户调用`RegisterSideChain`接口
   - 参数:
  
   - address  注册账户地址
	 - chainId  侧链Id
	 - router	  侧链Router
	 - name	    侧链名
	 - num		  块等待时间
	 - signer   申请注册账户
 -  同意注册侧链    同意注册侧链需四个Poly同步节点中的三个节点账户调用`ApproveRegisterSideChain`接口。
   - 参数：

	 - chainId  侧链Id
	 - signer	  poly同步节点账户
```sh
[zhousk@VM-16-16-centos toolbox]$ go test -run TestRegisterSideChain/regist_test -v
=== RUN   TestRegisterSideChain
waiting poly transaction ab309300dcd48aa07684c3f4008b82a75d699d3b22599d16c3d139e2a5d08f04 confirmed...
successful to register side chain: txhash: ab309300dcd48aa07684c3f4008b82a75d699d3b22599d16c3d139e2a5d08f04
waiting poly transaction f713d12fd19ff3cc6f0c5992099172fcb3866131fe4b1a7abd8f8863e9684825 confirmed...
第0次, successful to approve: ( acc: e0fa46e2e8acf6e1c9d98347e77407dbc629bfd0, txhash: f713d12fd19ff3cc6f0c5992099172fcb3866131fe4b1a7abd8f8863e9684825, chain-id: 14 )
waiting poly transaction e486c96a0612e4c78e2196493982cccc7f21301154f1f4567bed04aafb222ccc confirmed...
第1次, successful to approve: ( acc: 814c47d24c97370133968cd2de9a21739206ed8c, txhash: e486c96a0612e4c78e2196493982cccc7f21301154f1f4567bed04aafb222ccc, chain-id: 14 )
waiting poly transaction 72facb4456a87298b65df2febb3bdff865b050f33873933e12fa2784b6798fc7 confirmed...
第2次, successful to approve: ( acc: 147217ee18d862da9f0493cf8f5fd1c43cd30ff0, txhash: 72facb4456a87298b65df2febb3bdff865b050f33873933e12fa2784b6798fc7, chain-id: 14 )
TestRegisterSideChain: ApproveRegisterSideChain RPC faild error: ApproveRegisterSideChain failed: JsonRpcResponse error code:-1 desc:INTERNAL ERROR, ErrUnknown result:"[Invoke] Native serivce function execute error:ApproveRegisterSideChain, chainid is not requested"--- PASS: TestRegisterSideChain (61.95s)
```

#### 同步起始链创世节点到Poly
同步起始链创世节点逻辑（以下简称同步创世节点）
 - 同步创世节点      获取EOS起始链创世区块，调用`SyncGenesisHeader`接口。
   - 参数：

	 - chainId	侧链Id
	 - genesisHeader	EOS创世区块头
	 - signers	同步节点账户集（4个） 
```sh
[zhousk@VM-16-16-centos toolbox]$ go test -run SyncGenesisHeaderToPoly/regist_test -v
=== RUN   TestSyncGenesisHeaderToPoly
SyncGenesisHeader success, the return is: [42 117 193 162 195 139 133 210 167 111 121 35 245 89 230 118 192 160 189 124 221 237 153 88 55 181 34 95 36 171 78 69]
--- PASS: TestSyncGenesisHeaderToPoly (1.49s)
PASS
ok      github.com/polynetwork/eos_relayer/toolbox      1.553s
```


#### 同步Poly共识节点到目标链管理合约
同步Poly共识节点到目标链逻辑（以下简称同步共识节点）,调用目标链管理合约初始化方法`initgenblock`
 - 同步共识节点       获取Poly当前周期共识
   - 参数：
   - RawHeader       同步周期块的头信息
   - PubKeyList      本同步周期的共识节点公钥列表
```sh
[zhousk@VM-16-16-centos toolbox]$ go test -run TestSyncPolyHdrToEOS/regist_test -v
=== RUN   TestSyncPolyHdrToEOS
sender :[0xc0000ca6f0 0xc0000ca720]seed num is:0signedTx:{
  "expiration": "2023-01-09T03:44:01",
  "ref_block_num": 300,
  "ref_block_prefix": 3840489581,
  "max_net_usage_words": 0,
  "max_cpu_usage_ms": 0,
  "delay_sec": 0,
  "context_free_actions": [],
  "actions": [
    {
      "account": "ddcccmanager",
      "name": "initgenblock",
      "authorization": [
        {
          "actor": "janifer",
          "permission": "active"
        }
      ],
      "data": "b411303030303030303064623035366464313030303030303030376434346339353236613636356538373264326461353732353866623564623637666131366565393162366431333235313966343266386563346561396461343439346162323439333664383337383731623337396435313236666537623038653962656338393831633762313763323438346236623964666164323162633330303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030663737663738646263326231626337663836313236313061613139363032303664663665393334383862633633333263303032633234333435653630363636323761383762383633383034313365303037353764326162343364393862323836666461373033376232323663363536313634363537323232336133343263323237363732363635663736363136633735363532323361323234323464363137343465343133343262373034633439353035393462363333373736353236363436353235313333353435343436353535303333353136383334373336393262356134333639343737393731353635363533343734323737343636343663333134653637333836343432353635313432373636653465363436393433346237393663376136343631373233363738366335393636343333363464326235383739333937393466343133643232326332323736373236363566373037323666366636363232336132323333353833363530333935343732326236383737373036333739353234663532353835323730353133373736343636613436346534623335356132623735333434333664333337363736343936343635353337313434343333353731363133383535353737393735353036623635353135333534363533373639363237303665343235303731333833373334353835313531363635613262333334383638346533373331326233323439353133643364323232633232366336313733373435663633366636653636363936373566363236633666363336623566366537353664323233613334333033383330333033303330326332323665363537373566363336383631363936653566363336663665363636393637323233613762323237363635373237333639366636653232336133313263323237363639363537373232336133363339326332323665323233613334326332323633323233613331326332323632366336663633366235663664373336373566363436353663363137393232336133313330333033303330333033303330333033303330326332323638363137333638356636643733363735663634363536633631373932323361333133303330333033303330333033303330333033303263323237303635363537323566363836313665363437333638363136623635356637343639366436353666373537343232336133313330333033303330333033303330333033303330326332323730363536353732373332323361356237623232363936653634363537383232336133323263323236393634323233613232333133323330333533303333333836323338363136363336333233313330363536333636363436333632363336313632333233323335333533323635363633383634333836333636333433313633333636363338333636363339363336363339363136323335333336343338333633353337333433313633363636343632333833333333363633303336363232323764326337623232363936653634363537383232336133313263323236393634323233613232333133323330333533303332333833313337333233393331333833353334333036323332363233353331333236353631363533313338333733323631333236313332363533333631333233383634333933383339363333363330363433393335363436313632333833383332333936313634363133373634333736343634333733303336363433363335333832323764326337623232363936653634363537383232336133343263323236393634323233613232333133323330333533303332333633373339333933333330363133343332363136313636333336333336333933373339333836333631333836313333363633313332363533313333333436333330333133393334333033353338333133383634333733383333363433313331333733343338363533303333333936343635333833353331333533393338333832323764326337623232363936653634363537383232336133333263323236393634323233613232333133323330333533303332333433383332363136333632333633353336333436323331333936323339333033363335333336363336363533393633333833303336333233393332363533383631363133383333363633373338363533373631333933333338333236313332333436313336363536363635333433313633333036333330333636363333333932323764356432633232373036663733356637343631363236633635323233613562333132633331326333333263333332633332326333333263333432633334326333313263333432633331326333343263333432633332326333333263333232633332326333313263333432633331326333313263333132633331326333343263333232633334326333323263333332633334326333313263333232633334326333343263333432633333326333343263333332633334326333313263333332633333326333313263333132633333326333333263333232633332326333323263333232633333326333323263333432633333326333333263333132633332326333313263333232633333326333323564326332323664363137383566363236633666363336623566363336383631366536373635356637363639363537373232336133363330333033303330376437643736373736633336613863333033383436373235323936393066373333643935613538626264393498043132303530343438326163623635363462313962393036353366366539633830363239326538616138336637386537613933383261323461366566653431633063303666333965663061393565653630616439323133656230626533343362373033646433326231326462333266303938333530636633663466633362616436646232336365313230353034363739393330613432616166336336393739386361386133663132653133346330313934303538313864373833643131373438653033396465383531353938383735346633343832393363363530353566306631613961356538393565346537323639373339653234336136363166666638303139343133353263333837313231323035303438313732393138353430623262353132656165313837326132613265336132386439383963363064393564616238383239616461376437646437303664363538646630343465623933626265363938656666363231353666633134643664303762376165626662633161393865633431383062343334366536376363336662303132303530343862386166363231306563666463626361623232353532656638643863663431633666383666396366396162353364383635373431636664623833336630366237326663633765376438623965373338623536356564663432643837363966643136313137383433326561646232653434366464306138373835626130383866"
    }
  ],
  "transaction_extensions": [],
  "signatures": [
    "SIG_K1_K5SCNfsXx2tQsugvApNkumXKmgabayAnFcLnREnTeCUwDXP56DBd5kyw5n3foNoq1NoigyEtQrHtWcnukmAvjVm5BGFvhy"
  ],
  "context_free_data": []
}
PushTransaction success, txId:9e0cc0f8f6d04638c5268e0e8d213e132901547ccc3f3255f6728153bc498c0c
PushTransaction success, transaction ID :9e0cc0f8f6d04638c5268e0e8d213e132901547ccc3f3255f6728153bc498c0c
successful to sync poly header (hash: 3852eb4df3e173bab6781555cd4c09684624ef58b999005a70264a4202f46186, height: 4080000) to EOS: 
--- PASS: TestSyncPolyHdrToEOS (0.03s)
PASS
ok      github.com/polynetwork/eos_relayer/toolbox      0.097s
```

#### 部署跨链管理合约
钱包：jasmine
钱包密码：PW5KZkBiuu3aWenxchzciLq5MCy9iVpXVTGnozEAWwrfUwZJgXUSe
合约账户名： ddcccmanager
公钥：EOS6u3S5RbCxVrCE2sW7yBQLZ7fftaupqB85BLDeuV9j4eTBGCKX1


#### 部署ddc
cleos push action ddc.contract operatoradd '[ddc.operator,ddcccmanager,ddcccmanager,"cm\:ddc\:ccmanager","cm\:ddc\:manager"]' -p ddc.operator

cleos push action ddc.contract addfunction '[ddc.operator,"3","1","crosstrans"]' -p ddc.operator
cleos push action ddc.contract addfunction '[ddc.operator,"3","1","crossmint"]' -p ddc.operator

cleos push action ddc.contract recharge '[ddc.operator,ddcccmanager,"1000.0000\ FEE"]' -p ddc.operator

cleos push action ddc.contract crossinit '[ddcccmanager,"active",2]' -p ddc.contract(侧链ID)



handleNewBlock - fetchLockDepositEvents on height :16958361 failed



#### 删除管理合约内存表

```sh
root@f8f822c1c047:/# cleos push action ddcccmanager removepoly '[""]' -p ddcccmanager@active
executed transaction: 999b6401c34bf061cdef583cc09db784ab6311515c1d3392ad207f23e24df8ec  96 bytes  183 us
#  ddcccmanager <= ddcccmanager::removepoly     ""
warning: transaction executed locally, but may not be confirmed by the network yet         ]
```

```sh
the now header is&{{2023-01-04 11:12:26 +0800 CST eosio 0 0102c3997b4ee55cb0b8dacdbfe6cb9b916ba2fe3263be1cace9c31f1c30dd73 0000000000000000000000000000000000000000000000000000000000000000 fa8c86c8ded134f67c152ac7a9f7d7d397e14eb5dbe2822e7aff57f11ff07c6e 0 <nil> []} SIG_K1_KaEEexgvbyH16bcgdbtCdnadg8twzCVvYx5Cn1LrBcdw1kGv3PHkG4xefwo85rWYJwsFvrnGaq4a8r6H7NTeRYEmFkfZP3}
the pre header is &{{2023-01-04 11:12:25.5 +0800 CST eosio 0 0102c398b5c2f1ae3fb383e92adac8d1b0fede7333dba2d1c6877942cf10d473 0000000000000000000000000000000000000000000000000000000000000000 49948536ebb4105f60e6c47c6dd4c21f8fe3ac83e60935fdaf55fc1028b81faf 0 <nil> []} SIG_K1_KWcAXS9DVCKRUzpaHuNFkgLGk3uvaTc116SdE1bnshpigA5vhT3m2LxT2eNXjrj4saL48ta94YV5WsjX2XF6fzkEcSaNeb}
now header previous Id is 0102c3997b4ee55cb0b8dacdbfe6cb9b916ba2fe3263be1cace9c31f1c30dd73
pre header ID id 0102c3997b4ee55cb0b8dacdbfe6cb9b916ba2fe3263be1cace9c31f1c30dd73
bytes.Equal(hdrId, preID): true
now header privious ID Byte is [34 48 49 48 50 99 51 57 57 55 98 52 101 101 53 53 99 98 48 98 56 100 97 99 100 98 102 101 54 99 98 57 98 57 49 54 98 97 50 102 101 51 50 54 51 98 101 49 99 97 99 101 57 99 51 49 102 49 99 51 48 100 100 55 51 34]
pre header ID Byte is [34 48 49 48 50 99 51 57 57 55 98 52 101 101 53 53 99 98 48 98 56 100 97 99 100 98 102 101 54 99 98 57 98 57 49 54 98 97 50 102 101 51 50 54 51 98 101 49 99 97 99 101 57 99 51 49 102 49 99 51 48 100 100 55 51 34]
bytes.Equal(hdrIdByte, preIDByte): true
```





#### 修改日志

```sh

2023/01/06 16:49:58.313016 [INFO ] GID 16, handle confirmed poly Block height: 4041110 从10个输出一次日志，间距调大
checkMap:map[] 去掉
2023/01/06 17:08:14.374455 [INFO ] GID 52, filterCrossChainEvent -  height: 17346619 间距调大

```


15427



侧链ID 20

培养目标细一点，文档撰写靠后。
一一对应。
工作计划安排，学习不属于，改成具体工作项
培养措施：比工作计划要多。
将工作计划写的更细一些，更多一些。

报错
```sh
nohup: ignoring input
panic: runtime error: index out of range [7] with length 4

goroutine 16 [running]:
encoding/binary.littleEndian.PutUint64(...)
        /usr/local/go/src/encoding/binary/binary.go:83
github.com/polynetwork/eos_relayer/db.(*BoltDB).UpdatePolyHeight(0xc0003aa500, 0x3e6249?)
        /home/zhousk/poly-network/eos-relayer/db/db.go:229 +0x95
github.com/polynetwork/eos_relayer/manager.(*PolyManagerEOS).MonitorChain(0xc00017e000)
        /home/zhousk/poly-network/eos-relayer/manager/polymanager_eos.go:201 +0x2a5
created by main.initPolyServer
        /home/zhousk/poly-network/eos-relayer/main.go:167 +0xd6
exit status 2
```


#### 获取跨链管理合约当前poly周期
```sh
root@f8f822c1c047:/# cleos get table ddcccmanager ddcccmanager polyglobal
{
  "rows": [{
      "primary": 0,
      "conKeepersPkBytes": [
        4,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        32,
        33,
        113,
        76,
        232,
        70,
        239,
        183,
        12,
        253,
        29,
        216,
        156,
        121,
        11,
        37,
        233,
        58,
        25,
        207,
        0,
        241,
        163,
        160,
        240,
        12,
        106,
        115,
        1,
        10,
        216,
        248,
        180,
        32,
        206,
        246,
        39,
        80,
        86,
        75,
        202,
        168,
        199,
        93,
        26,
        219,
        55,
        163,
        200,
        102,
        170,
        245,
        247,
        53,
        179,
        22,
        149,
        152,
        246,
        119,
        254,
        78,
        240,
        141,
        112,
        252,
        32,
        88,
        213,
        201,
        87,
        107,
        134,
        130,
        115,
        203,
        124,
        63,
        209,
        91,
        67,
        255,
        224,
        238,
        145,
        101,
        235,
        125,
        232,
        121,
        41,
        165,
        199,
        192,
        8,
        119,
        54,
        41,
        150,
        32,
        122,
        175,
        46,
        190,
        100,
        95,
        99,
        125,
        90,
        98,
        118,
        195,
        52,
        26,
        105,
        93,
        227,
        111,
        223,
        21,
        201,
        231,
        223,
        176,
        15,
        54,
        208,
        103,
        12,
        217,
        65,
        12
      ],
      "curEpochStartHeight": 4080000
    }
  ],
  "more": false,
  "next_key": "",
  "next_key_bytes": ""
}
```
